参考：  
《你不知道的JavaScript（上卷）》  
《JavaScript高级程序指南3》  
由于才疏学浅，没有办法从最底层系统性的了解JavaScript中比较晦涩的概念，所以结合参考资料及google，做个简单的总结，便于自己的理解，也方便以后查缺补漏，仅供参考。
# 1. 编译原理
<!-- 闭包的本质是「 词法作用域的一种体现 」，是函数的一种实现方式。 -->
在传统编译语言的流程中，从大的方面来讲，程序中的一段源代码在执行前会经历三个步骤：
  - **分词/词法分析**  
    词法化阶段，这个过程会将由字符组成的字符串分解成有意义的代码块（对编程语言来说）
  - **解析/语法分析**  
    这个过程是将词法单元流（数组）转换成一个由元素逐级嵌套多组成的代表了程序语法结构的树，就是**抽象语法树（AST）**。以 `var a = 2;` 语句举例：
    <img-show :img-info="{src:'https://raw.githubusercontent.com/7neves/CloudImg/master/images/20191025145953.png',description:'抽象语法树'}" />
  - **代码生成**  
    这个阶段是将AST转换为可执行代码的过程。  

JavaScript也是一门需要编译的语言，但是比起传统编译语言的三个步骤，JavaScript会更为复杂（一些编译优化等）；对于JavaScript来说，大部分情况下**编译发生在代码执行前**的极短的时间内；任何JavaScript代码片段在执行前都要进行编译（通常就在执行前）；因此JavaScript编译器首先会对`var a = 2;`这段程序进行编译，将其转化为一组机器指令，用来创建一个叫做a的变量（包括为其分配内存等），并将一个值储存在a中，这样就完成了一个代码编译执行的过程。
## 1.1 作用域
在《你不知道的JavaScript（上卷）--作用域是什么》 章节，用“演员对话”的方式很生动的介绍了引擎、编译器和作用域的关系，它们是一个层级的概念，“并且关系要好”，是互相协同合作的关系。  
  - 引擎  
    负责整个JavaScript程序的编译及执行过程。
  - 编译器  
    负责语法分析及代码生成等编译工作
  - 作用域  
> **作用域是一套规则，用于规定在何处以及如何查找变量**。它负责收集并维护所有声明的标识符（变量）组成的一系列查询，并实施一套非常严格的规则，确定当前执行的代码对这些标识符的访问权限。

还是`var a = 2;`这条语句的执行，文中提出了一个合理的假设：“为一个变量分配内存，并将其命名为a，然后将值2保存进这个变量。”起初我确实是这么认为的，然鹅，这并不完全正确，来看看JavaScript整个执行过程中它们三者是如何工作的：
<img-show :img-info="{src:'https://raw.githubusercontent.com/7neves/CloudImg/master/images/20191025135211.jpg',description:'变量的赋值操作'}"/>

  - 总结：  
    **作用域是一套规则，用于确定当前执行代码的可访问变量的权限**。
## 1.2 词法作用域
在《编译原理》章节说到编译的第一个阶段，就是进行词法化，这个过程会对源代码中的字符进行检查，分析成对编程语言有意义的代码。  
而词法作用域就是定义在该阶段的作用域，而且一旦定义就不会被改变。也就是说**你在写代码时将函数声明写在哪里就已经决定了函数的作用域**，一个很典型的例子：
```js
var a = 1;
function foo() {
  console.log(a);
}
function bar() {
  var a = 2;
  foo();
}
bar(); // 1
```
按书写的顺序，在foo()函数定义的时候，已经持有对全局变量a的引用，所以不论在何处执行，都是持有对全局变量a的引用。

## 1.2 执行环境
上文中说到在JavaScript在执行阶段，创建了执行环境，那就来看看执行环境。
- **概念**  
  执行环境（又称为执行上下文环境或环境），是ECMAScript **运行时(runtime)** 的上下文环境：
  > 执行环境定义了变量或函数有权访问的其它数据，决定了它们各自的行为。每个执行环境都有一个与之关联的**变量对象**，环境中定义的所有变量和函数都保存在这个对象中。  

  > 当执行流进入一个函数时，函数的环境就会被推入一个环境栈中。某个执行环境中的所有代码执行完毕后，该环境被销毁，保存在其中的所有变量和函数定义也随之销毁。栈将其环境弹出，把控制权返回给之前的（上一层）执行环境。
  
  --《JavaScript高程3》  
  也就是说**每个函数都有自己的执行环境**，这就是**局部执行环境**，最外层的执行环境为**全局执行环境**（全局执行环境会根据ECMAScript实现的宿主环境的不同而改变，在web浏览器中，全局执行环境就是window对象，因此所有全局变量和函数都是作为window对象的属性和方法创建的）。
- **特征**  
由于栈是先进后出的的结构，综合上文，执行环境有以下特点：
  - 同步执行（只有栈顶的执行环境处于执行中，其它的执行环境都在等待）
  - 单线程（依次执行）
  - 唯一的全局执行环境
  - 局部执行环境没有数量的限制
  - 函数的每次调用，都会创建一个新的局部环境，即便是多次调用同一个函数，也会创建多个不同的局部环境  
- **生命周期**  
执行环境可以分为创建和执行两个阶段；
  - 在创建阶段，解析器会创建执行环境的**变量对象**，建立作用域链，确定`this`的指向；
  - 在执行阶段，代码被解释执行。  
  <img-show :img-info="{src:'https://raw.githubusercontent.com/7neves/CloudImg/master/images/20191023100824.png',description:'执行环境生命周期'}"/>

## 1.3 作用域链
在执行环境的生命周期中，创建阶段会建立作用域链。**作用域链的用途，就是为了保证对执行环境有权访问的所有变量和函数进行有序的访问。**  
 我们都知道JavaScript中的作用域分全局作用域和函数作用域，函数是可以嵌套的，函数作用域也会嵌套在全局作用域下，这就会发生作用域的嵌套。当要查找的某个变量在当前作用域中不存在时，就会向上一级作用域中进行查找，直到全局作用域，这就形成了作用域链。
 其中
 > 内部环境可以通过作用域链访问所有的外部环境，但外部环境不能访问内部环境中的任何变量和函数。这些环境之间的联系是线性的（向上搜索）、有次序（逐层）的。