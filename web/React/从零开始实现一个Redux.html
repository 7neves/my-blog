<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Seven&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="积跬步以至千里，积小流以成江海">
    
    <link rel="preload" href="/assets/css/0.styles.9a488dde.css" as="style"><link rel="preload" href="/assets/js/app.8fcb3c07.js" as="script"><link rel="preload" href="/assets/js/2.ea4b5fde.js" as="script"><link rel="preload" href="/assets/js/27.8d7291fd.js" as="script"><link rel="prefetch" href="/assets/js/10.ceaff0cb.js"><link rel="prefetch" href="/assets/js/11.602a1a57.js"><link rel="prefetch" href="/assets/js/12.7c9a3565.js"><link rel="prefetch" href="/assets/js/13.cb26c009.js"><link rel="prefetch" href="/assets/js/14.db9f58ed.js"><link rel="prefetch" href="/assets/js/15.c07f99aa.js"><link rel="prefetch" href="/assets/js/16.bbea5198.js"><link rel="prefetch" href="/assets/js/17.bd355204.js"><link rel="prefetch" href="/assets/js/18.069c6795.js"><link rel="prefetch" href="/assets/js/19.2d2f3f2c.js"><link rel="prefetch" href="/assets/js/20.4bf50484.js"><link rel="prefetch" href="/assets/js/21.1bfa4a30.js"><link rel="prefetch" href="/assets/js/22.9b54ca32.js"><link rel="prefetch" href="/assets/js/23.17047d1d.js"><link rel="prefetch" href="/assets/js/24.d36a307c.js"><link rel="prefetch" href="/assets/js/25.f5c553f3.js"><link rel="prefetch" href="/assets/js/26.cfb8865a.js"><link rel="prefetch" href="/assets/js/28.ac3b40d5.js"><link rel="prefetch" href="/assets/js/29.d97a3e56.js"><link rel="prefetch" href="/assets/js/3.482fc7d1.js"><link rel="prefetch" href="/assets/js/30.f58a4260.js"><link rel="prefetch" href="/assets/js/31.9294edd4.js"><link rel="prefetch" href="/assets/js/32.753d88bb.js"><link rel="prefetch" href="/assets/js/33.4259510b.js"><link rel="prefetch" href="/assets/js/34.767c2061.js"><link rel="prefetch" href="/assets/js/35.ee551374.js"><link rel="prefetch" href="/assets/js/36.67e65bf0.js"><link rel="prefetch" href="/assets/js/37.39a7a34a.js"><link rel="prefetch" href="/assets/js/4.6162bcf8.js"><link rel="prefetch" href="/assets/js/5.43fabd26.js"><link rel="prefetch" href="/assets/js/6.bfd296f5.js"><link rel="prefetch" href="/assets/js/7.da21fdf7.js"><link rel="prefetch" href="/assets/js/8.13301773.js"><link rel="prefetch" href="/assets/js/9.d46e2aae.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9a488dde.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Seven's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/web/" class="nav-link router-link-active">
  web前端
</a></div><div class="nav-item"><a href="/utils/" class="nav-link">
  其他
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/web/" class="nav-link router-link-active">
  web前端
</a></div><div class="nav-item"><a href="/utils/" class="nav-link">
  其他
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>React</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/web/React/React基础.html" class="sidebar-link">React基础</a></li><li><a href="/web/React/如何开发React应用.html" class="sidebar-link">如何开发React应用</a></li><li><a href="/web/React/Redux基础.html" class="sidebar-link">Redux基础</a></li><li><a href="/web/React/Redux进阶.html" class="sidebar-link">Redux进阶</a></li><li><a href="/web/React/从零开始实现一个Redux.html" class="active sidebar-link">从零开始实现一个Redux</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/React/从零开始实现一个Redux.html#_1-状态容器" class="sidebar-link">1. 状态容器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/React/从零开始实现一个Redux.html#_1-最简单的状态管理器" class="sidebar-link">1. 最简单的状态管理器</a></li><li class="sidebar-sub-header"><a href="/web/React/从零开始实现一个Redux.html#_2-发布-订阅模式" class="sidebar-link">2. 发布-订阅模式</a></li><li class="sidebar-sub-header"><a href="/web/React/从零开始实现一个Redux.html#_3-封装状态管理器" class="sidebar-link">3. 封装状态管理器</a></li><li class="sidebar-sub-header"><a href="/web/React/从零开始实现一个Redux.html#_4-有计划的状态管理器" class="sidebar-link">4. 有计划的状态管理器</a></li></ul></li><li class="sidebar-sub-header"><a href="/web/React/从零开始实现一个Redux.html#_2-combinereducers函数" class="sidebar-link">2. combineReducers函数</a></li><li class="sidebar-sub-header"><a href="/web/React/从零开始实现一个Redux.html#_3-middleware-中间件" class="sidebar-link">3. middleware 中间件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/React/从零开始实现一个Redux.html#_1-改造dispatch" class="sidebar-link">1. 改造dispatch</a></li><li class="sidebar-sub-header"><a href="/web/React/从零开始实现一个Redux.html#_2-高扩展性的多中间件合作模式" class="sidebar-link">2. 高扩展性的多中间件合作模式</a></li><li class="sidebar-sub-header"><a href="/web/React/从零开始实现一个Redux.html#_3-中间件使用优化-applymiddleware" class="sidebar-link">3. 中间件使用优化--applyMiddleware</a></li><li class="sidebar-sub-header"><a href="/web/React/从零开始实现一个Redux.html#_4-省略-initstate" class="sidebar-link">4. 省略 initState</a></li></ul></li><li class="sidebar-sub-header"><a href="/web/React/从零开始实现一个Redux.html#_4-总结redux" class="sidebar-link">4. 总结Redux</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react-router</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>UmiJS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Utils</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/web/Mobile.html" class="sidebar-link">Mobile</a></li><li><a href="/web/ElementUI.html" class="sidebar-link">ElementUI</a></li><li><a href="/web/FastMock.html" class="sidebar-link">fastmock</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>面试题</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><a href="https://github.com/brickspert/blog/issues/22" target="_blank" rel="noopener noreferrer">【原文】<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="_1-状态容器"><a href="#_1-状态容器" class="header-anchor">#</a> 1. 状态容器</h2> <blockquote><p>Redux 是 JavaScript 状态容器，提供可预测化的状态管理。</p></blockquote> <p>redux就是个管理状态的容器，那么先来实现一个最简单的状态管理器。</p> <h3 id="_1-最简单的状态管理器"><a href="#_1-最简单的状态管理器" class="header-anchor">#</a> 1. 最简单的状态管理器</h3> <p>所谓状态，就是数据，如下面的 <code>count</code>：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token punctuation">{</span>
  count<span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>使用状态，在界面显示出来：</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>onClick()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>按钮<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>当前状态：<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>state<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'state'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> state<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
</code></pre></div><p>修改状态:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  state<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样就是最最最简单的状态管理，这也是 <code>Redux</code> 最核心的东西。下面来逐步完善，使之更像我们已知的 <code>Redux</code>。</p> <p>这个最简单的状态管理器存在一个问题：<em>当修改状态的时候，在使用状态的地方无法更改到最新的状态值</em>。</p> <h3 id="_2-发布-订阅模式"><a href="#_2-发布-订阅模式" class="header-anchor">#</a> 2. 发布-订阅模式</h3> <p>为了解决上述问题，来引进<strong>发布-订阅模式</strong>，在状态更改的时候，在使用状态的地方能收到通知，进而更新状态。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 订阅</span>
<span class="token keyword">function</span> <span class="token function">subScript</span><span class="token punctuation">(</span><span class="token parameter">listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  listeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 修改状态</span>
<span class="token keyword">function</span> <span class="token function">changeState</span><span class="token punctuation">(</span><span class="token parameter">count</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  state<span class="token punctuation">.</span>count <span class="token operator">=</span> count<span class="token punctuation">;</span>
	<span class="token comment">// 当状态改变的时候，通知所有的订阅者  </span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> listeners<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> listener <span class="token operator">=</span> listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>再来使用下这个简单的状态管理器：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 首先需要添加订阅</span>
<span class="token function">subScript</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'state'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> state<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 触发更新</span>
<span class="token keyword">function</span> <span class="token function">onClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">changeState</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样点击按钮，状态改变，界面显示的状态值也会发生变化。</p> <p>这样的一个状态管理器比之前好了很多，但是仍然有两个问题：</p> <ul><li>只能管理 <code>count</code>这一个状态，不够通用</li> <li>对外暴露了太多变量，方法</li></ul> <h3 id="_3-封装状态管理器"><a href="#_3-封装状态管理器" class="header-anchor">#</a> 3. 封装状态管理器</h3> <p>为了实现通用和减少变量的暴露，将代码进行一个封装</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">createStore</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">initState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> initState<span class="token punctuation">;</span>
  
  <span class="token comment">// 订阅</span>
  <span class="token keyword">let</span> listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token keyword">function</span> <span class="token function">subScript</span><span class="token punctuation">(</span><span class="token parameter">listener</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    listeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 修改状态</span>
  <span class="token keyword">function</span> <span class="token function">changeState</span><span class="token punctuation">(</span><span class="token parameter">newState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    state <span class="token operator">=</span> newState<span class="token punctuation">;</span>
    <span class="token comment">// 当状态改变的时候，通知所有的订阅者  </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> listeners<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> listener <span class="token operator">=</span> listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">function</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
  <span class="token comment">// 对外提供接口</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    getState<span class="token punctuation">,</span>
    subScript<span class="token punctuation">,</span>
    changeState<span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用封装过的状态管理器</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> initState <span class="token operator">=</span> <span class="token punctuation">{</span>
  count<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  info<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">'Seven'</span><span class="token punctuation">,</span>
    age<span class="token operator">:</span> <span class="token number">30</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>initState<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*-----添加自定义订阅-----*/</span>
store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> state<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> state<span class="token punctuation">.</span>info<span class="token punctuation">.</span>age<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> state<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">/*-----改变状态-----*/</span>
<span class="token keyword">function</span> <span class="token function">changeInfoState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">changeState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    info<span class="token operator">:</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'Seven'</span><span class="token punctuation">,</span>
      age<span class="token operator">:</span> <span class="token number">30</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 来实现一个count的自增和自减</span>
<span class="token keyword">function</span> <span class="token function">inCrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">changeState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    count<span class="token operator">:</span> store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">deCrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">changeState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    count<span class="token operator">:</span> store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count <span class="token operator">-</span> <span class="token number">1</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样的一个状态管理器用起来就好了很多，很通用，且不用关心其内部的逻辑。再来看一个问题，这里的 <code>count</code>是一个数值，如果将其改变为字符串，是否也可以呢</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">changeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">changeState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    count<span class="token operator">:</span> <span class="token string">'哈哈哈'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>发现也是可行的，它不具有任何限定性，最初说到 <em>Redux提供的是可预测化的状态管理</em> ，那么如何让它可预测呢？那就是我们给它制定一个计划，让其按照“计划”只执行自增或自减。</p> <p><img src="https://s17.aconvert.com/convert/p3r68-cdx67/87b46-fal8a.gif" alt=""></p> <h3 id="_4-有计划的状态管理器"><a href="#_4-有计划的状态管理器" class="header-anchor">#</a> 4. 有计划的状态管理器</h3> <p>分两步解决上述无法限定状态更新的问题</p> <ul><li>制定一个 state 修改计划，然后告诉 store 计划的内容</li> <li>修改 store.changeState 方法，告诉它修改 state 的时候，按照计划进行修改</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 首先制定一个 plan 函数，接收现在的 state，和一个 action，返回经过修改后的 state</span>
<span class="token comment">// action 必须包含一个 type 属性</span>
<span class="token keyword">function</span> <span class="token function">plan</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 	<span class="token keyword">let</span> type <span class="token operator">=</span> action<span class="token punctuation">.</span>type<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> type<span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'INCREMENT'</span><span class="token operator">:</span>
    	<span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>state<span class="token punctuation">,</span>
        count<span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'DECREMENT'</span><span class="token operator">:</span>
  		<span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>state<span class="token punctuation">,</span>
        count<span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">-</span> <span class="token number">1</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 然后修改 store.changeState 方法，告诉它修改 state 的时候，按照计划进行修改</span>
<span class="token keyword">const</span> <span class="token function-variable function">createStore</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">plan<span class="token punctuation">,</span> initState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  <span class="token keyword">function</span> <span class="token function">changeState</span><span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/*请按照计划修改 state*/</span>  
    state <span class="token operator">=</span> <span class="token function">plan</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> listeners<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> listener <span class="token operator">=</span> listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>使用有计划的状态管理器</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> initState <span class="token operator">=</span> <span class="token punctuation">{</span>
  count<span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token comment">// 传入plan函数</span>
<span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>initState<span class="token punctuation">,</span> plan<span class="token punctuation">)</span><span class="token punctuation">;</span>

store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> state<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 有效的更改</span>
<span class="token keyword">function</span> <span class="token function">inCrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">changeState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'INCREMENT'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">deCrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">changeState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'DECREMENT'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 是无效的</span>
<span class="token keyword">function</span> <span class="token function">changeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">changeState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token operator">...</span>store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    count<span class="token operator">:</span> <span class="token string">'abd'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="https://s31.aconvert.com/convert/p3r68-cdx67/z7zl2-3qj69.gif" alt=""></p> <p>这样就实现了一个有“计划”的状态管理器，尝试改变下其中一些方法的名字：</p> <ul><li><code>plan</code> 改为 <code>reducer</code></li> <li><code>changeState</code> 改为 <code>dispatch</code></li></ul> <p>这样看起来，是不是就是一个 Redux 了 😁（下面的例子都是后面的命名方式）</p> <h2 id="_2-combinereducers函数"><a href="#_2-combinereducers函数" class="header-anchor">#</a> 2. combineReducers函数</h2> <p>这个有计划的状态管理器目前已经够用了，下面来进行一些优化，前面说到<code>reducer</code>是计划函数，针对不同的状态，做出不同的更新计划（reducer函数），但是我们的项目都不可能仅仅是一两个状态，当状态过多时，就要写很多的 <code>reducer</code> 导致reducer函数越发臃肿，难以维护。这样的情况下，通常会按照某个维度（比如组件）进行拆分，然后通过一个函数将它们组合起来，达到解耦的目的。</p> <p>下面来管理多个state，一个是 counter，一个是 info：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> initState <span class="token operator">=</span> <span class="token punctuation">{</span>
  counter<span class="token operator">:</span> <span class="token punctuation">{</span>
    count<span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  info<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    age<span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>它们拥有各自的更新计划函数reducer：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 计划函数</span>
<span class="token comment">// 注意，这里的state为 state.counter</span>
<span class="token keyword">function</span> <span class="token function">countReducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;INCREMENT&quot;</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>state<span class="token punctuation">,</span>
        count<span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">+</span> <span class="token number">1</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">case</span> <span class="token string">&quot;DECREMENT&quot;</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
          <span class="token operator">...</span>state<span class="token punctuation">,</span>
          count<span class="token operator">:</span> state<span class="token punctuation">.</span>count <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 注意，这里的state为 state.info</span>
<span class="token keyword">function</span> <span class="token function">infoReducer</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'SET_NAME'</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>state<span class="token punctuation">,</span>
        name<span class="token operator">:</span> action<span class="token punctuation">.</span>name
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'SET_AGE'</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>state<span class="token punctuation">,</span>
        name<span class="token operator">:</span> action<span class="token punctuation">.</span>age
      <span class="token punctuation">}</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>下面就要用 <code>combineReducers</code> 函数将它们合并成一个 reducer 函数。<strong>reducer 函数的作用就是传入旧的 <code>state</code> ,返回新的 <code>state</code></strong>。所以，合并 reducer 的思路大概是这样的：</p> <ol><li><p>遍历执行所有的 reducer</p></li> <li><p>将前一个 reducer 返回的 state ，作为下一个 reducer 的参数</p></li> <li><p>返回最终的 state</p></li> <li><p>使用的时候大概是这样来使用，每一个 state 对应一个 reducer 函数，这样能保持一致</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> reducer <span class="token operator">=</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  counter<span class="token operator">:</span> countReducer<span class="token punctuation">,</span> <span class="token comment">// 每个 key 对应一个状态，状态值即为其对应的 reducer 函数</span>
  info<span class="token operator">:</span> infoReducer
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ol> <p>根据上面的思路，来实现一下 <code>combineReducers</code> 函数：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token parameter">reducers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取到对应的 state </span>
  <span class="token keyword">const</span> reducers <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">combination</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 生成新的 state</span>
    <span class="token keyword">const</span> nextState <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> reducers<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> key <span class="token operator">=</span> reducers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> reducer <span class="token operator">=</span> reducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 获取旧的 state</span>
      <span class="token keyword">const</span> proviceStateForKey <span class="token operator">=</span> state<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment">// 传递旧的 state 并执行其对应的 reducer ，获取新的 state</span>
      <span class="token keyword">const</span> nextStateForKey <span class="token operator">=</span> <span class="token function">reducer</span><span class="token punctuation">(</span>proviceStateForKey<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      nextState<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> nextStateForKey<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> nextState<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用 reduce() 方法可以简化上面的代码</span>
<span class="token keyword">function</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token parameter">reducers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">combination</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span>
    	<span class="token punctuation">(</span><span class="token parameter">nextState<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        nextState<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> reducers<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>state<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> nextState<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 注意：一定要传入 reduce 函数的 initialValue 参数</span>
      <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>来使用下这个合并  reducer 的方法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> reducer <span class="token operator">=</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  counter<span class="token operator">:</span> countReducer<span class="token punctuation">,</span> <span class="token comment">// 每个 key 对应一个状态，状态值即为其对应的 reducer 函数</span>
  info<span class="token operator">:</span> infoReducer
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> initState <span class="token operator">=</span> <span class="token punctuation">{</span>
  counter<span class="token operator">:</span> <span class="token punctuation">{</span>
    count<span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  info<span class="token operator">:</span> <span class="token punctuation">{</span>
    name<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    age<span class="token operator">:</span> <span class="token number">0</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>initState<span class="token punctuation">,</span> reducer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 添加订阅</span>
store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'count'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> state<span class="token punctuation">.</span>counter<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> state<span class="token punctuation">.</span>info<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
  document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerText <span class="token operator">=</span> state<span class="token punctuation">.</span>info<span class="token punctuation">.</span>age<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 改变状态</span>
<span class="token keyword">function</span> <span class="token function">inCrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'INCREMENT'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">deCrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'DECREMENT'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">changeInfoState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'SET_NAME'</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token string">'Seven'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token string">'SET_AGE'</span><span class="token punctuation">,</span>
    age<span class="token operator">:</span> <span class="token number">32</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>到这里，已经差不多实现了一个简单的 Redux ，仔细研究这里面的每个环节，结合 Redux 教程，就会明白很多设计为什么必须那么做了。比如：</p> <ul><li>在生成 Store 的时候，必须先将 Reducer 传入<code>createStore</code>方法</li> <li>action 必须有一个 type 属性</li> <li>reducer 必须是一个纯函数，因为它只是一个提供“计划方案”的函数，用来接收旧的状态，返回新的状态</li></ul> <h2 id="_3-middleware-中间件"><a href="#_3-middleware-中间件" class="header-anchor">#</a> 3. middleware 中间件</h2> <blockquote><p>中间件是对 dispatch 的扩展，或者说重写，增强 dispatch 的功能！</p></blockquote> <p>从上面实现的简单的 Redux 来看 <code>dispatch</code> 就是 <code>changeState</code> 函数，也就是改变状态的函数，对其进行扩展，使之具备更强大的功能。</p> <h3 id="_1-改造dispatch"><a href="#_1-改造dispatch" class="header-anchor">#</a> 1. 改造dispatch</h3> <p>首先将 <code>store.dispatch</code> 函数指针定义为 <code>next</code> 变量，接下来在中间件函数中使用，以改变状态。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> next <span class="token operator">=</span> store<span class="token punctuation">.</span>dispatch<span class="token punctuation">;</span>
</code></pre></div><ol><li><p>日志记录功能</p> <p>日常开发可能都有这样的需求，想要在改变状态的时候添加一些日志记录的功能：记录下修改前的 state ，为什么修改了，以及修改后的 state等等。那么就需要对 <code>changeState()</code> 方法（也就是<code>dispatch()</code>）进行改造了：</p> <div class="language-js extra-class"><pre class="language-js"><code>store<span class="token punctuation">.</span><span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">当前state:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">action:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">更改后的state:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个时候改变状态，会看到有日志输出：</p> <div class="language-js extra-class"><pre class="language-js"><code>当前state<span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;counter&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;info&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
redux<span class="token punctuation">.</span>html<span class="token operator">:</span><span class="token number">490</span> action<span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;type&quot;</span><span class="token operator">:</span><span class="token string">&quot;INCREMENT&quot;</span><span class="token punctuation">}</span>
redux<span class="token punctuation">.</span>html<span class="token operator">:</span><span class="token number">492</span> 更改后的state<span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;counter&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;count&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">&quot;info&quot;</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token string">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;age&quot;</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
</code></pre></div></li> <li><p>异常处理功能</p> <p>再来一个新的需求，希望能在修改状态异常的时候捕获异常：</p> <div class="language-js extra-class"><pre class="language-js"><code>store<span class="token punctuation">.</span><span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">当前错误信息：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <p>这样改造后的 <code>dispatch</code> 具备了一些扩展功能，但是还有个问题：<em>这些扩展功能之间怎么合作呢？</em></p> <h3 id="_2-高扩展性的多中间件合作模式"><a href="#_2-高扩展性的多中间件合作模式" class="header-anchor">#</a> 2. 高扩展性的多中间件合作模式</h3> <ol><li><p>多个中间件的合作</p> <p>如果希望既能记录日志又能捕获异常的话，首先想到的可能是上面两部分代码进行融合了：</p> <div class="language-js extra-class"><pre class="language-js"><code>store<span class="token punctuation">.</span><span class="token function-variable function">dispatch</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
  	<span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">当前state:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">action:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">更改后的state:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">当前错误信息：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样的情况，如果再有新的需求怎么办呢？可能就是不断的添加代码，dispatch 又庞大的无法维护了，这是不可取的！</p> <p>我们需要考虑如何实现<strong>扩展性很强的多中间件合作模式</strong>。</p></li> <li><p>抽离日志记录功能—loggerMiddleware</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">loggerMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">当前state:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">action:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">更改后的state:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>抽离捕获异常功能--exceptionMiddleware</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">exceptionMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">loggerMiddleware</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">错误信息: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>改造抽离的功能函数，使之更具扩展性</p> <ol><li><p>解耦 <code>next</code></p> <p>上述两个抽离的功能函数，都存在一些问题：</p> <ul><li><code>loggerMiddleware</code>中的 <code>next</code> 恒等于 <code>store.dispatch</code> ，导致无法扩展别的中间件</li> <li><code>exceptionMiddleware</code> 存在同样的问题，写死了 <code>loggerMiddleware</code> ，导致其扩展性很差</li></ul> <p>基于这两个问题，对抽离的中间件函数进行改造：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 将写死的内容，使用参数进行传递</span>

<span class="token comment">// 日志记录功能--loggerMiddleware</span>
<span class="token keyword">const</span> <span class="token function-variable function">loggerMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">当前state:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">action:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">更改后的state:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token comment">// 捕获异常功能--exceptionMiddleware</span>
<span class="token keyword">const</span> <span class="token function-variable function">exceptionMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
  <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">错误信息: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p>到这里为止，已经探索出了一个扩展性很高的中间件合作模式！来使用下这些中间件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> next <span class="token operator">=</span> store<span class="token punctuation">.</span>dispatch<span class="token punctuation">;</span>

<span class="token comment">// 日志记录功能--loggerMiddleware</span>
<span class="token keyword">const</span> <span class="token function-variable function">loggerMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> state <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getSate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">当前state:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">action:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">更改后的state:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>state<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

<span class="token comment">// 捕获异常功能--exceptionMiddleware</span>
<span class="token keyword">const</span> <span class="token function-variable function">exceptionMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">错误信息: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

store<span class="token punctuation">.</span>dispatch <span class="token operator">=</span> <span class="token function">exceptionMiddleware</span><span class="token punctuation">(</span><span class="token function">loggerMiddleware</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这样看起来很不错，它们运行的都很好。再仔细看下，如果想进一步的解耦，将中间件都封装在一个独立的 <code>.js</code> 文件中，会出现什么问题呢？<code>loggerMiddleware</code> 中的 <code>store</code> 还是写死的，是没有办法将中间件函数进行独立抽离的。</p></li> <li><p>解耦 <code>store</code></p> <p>针对上面的问题对 <code>store</code> 进行处理：将 <code>store</code> 作为一个参数传入中间件函数</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 日志记录功能--loggerMiddleware</span>
<span class="token keyword">const</span> <span class="token function-variable function">loggerMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">旧的state:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">新的state:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 捕获异常功能--exceptionMiddleware</span>
<span class="token keyword">const</span> <span class="token function-variable function">exceptionMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">错误信息: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>error<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建一个新的中间件，在记录日志前能记录下当前的时间</span>
<span class="token comment">// 时间记录--timmerMiddleware</span>
<span class="token keyword">const</span> <span class="token function-variable function">timeMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">store</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token parameter">action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">time:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">next</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用中间件</span>
<span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">loggerMiddleware</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> exception <span class="token operator">=</span> <span class="token function">exceptionMiddleware</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token function">timeMiddleware</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 这就是想要的结果</span>
store<span class="token punctuation">.</span>dispatch <span class="token operator">=</span> <span class="token function">exception</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token function">logger</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这样就可以将中间件独立成一个 <code>.js</code> 文件，在使用的时候导入即可。</p></li></ol></li></ol> <h3 id="_3-中间件使用优化-applymiddleware"><a href="#_3-中间件使用优化-applymiddleware" class="header-anchor">#</a> 3. 中间件使用优化--applyMiddleware</h3> <p>针对上面实现的中间件来说是没什么问题了，但是在使用的时候，会稍显麻烦，如何忽略那些使用方法，我们只用知道有三个中间件就行，让 <code>createStore</code> 去处理它们，看下我们期望的（也是Redux所实现的）做法：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/*接收旧的 createStore，返回新的 createStore*/</span>
<span class="token keyword">const</span> newCreateStore <span class="token operator">=</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>exceptionMiddleware<span class="token punctuation">,</span> timeMiddleware<span class="token punctuation">,</span> loggerMiddleware<span class="token punctuation">)</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*返回了一个 dispatch 被重写过的 store*/</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">newCreateStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol><li><p>实现 <code>applyMiddleware</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">applyMiddleware</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>middlewares</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 返回一个重写 createStore 的方法</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">rewriteCreateStoreFun</span><span class="token punctuation">(</span><span class="token parameter">oldCreateStore</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 返回重写后新的 createStore</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">newCreateStore</span><span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> initState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 1. 生成store</span>
      <span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">oldCreateStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initState<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">/**
       * 给每个 middleware 传下store，相当于：
       * const logger = loggerMiddleware(store);
       * const time = timeMiddleware(store);
       * const chain = [logger, time];
       * */</span>
      <span class="token keyword">const</span> chain <span class="token operator">=</span> middlewares<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">middleware</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> next <span class="token operator">=</span> store<span class="token punctuation">.</span>dispatch<span class="token punctuation">;</span>
      <span class="token comment">// 相当于 store.dispatch = time(logger(next));</span>
      chain<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">middleware</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>next <span class="token operator">=</span> <span class="token function">middleware</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 2. 重写 store.dispatch</span>
      store<span class="token punctuation">.</span>dispatch <span class="token operator">=</span> next<span class="token punctuation">;</span>
      <span class="token comment">// 返回新的 store</span>
      <span class="token keyword">return</span> store<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>下面就可以像上述方法一样，来使用 <code>applyMiddleware</code>。</p></li> <li><p>优化使用体验</p> <p>现在对于我们来说，有两种 store ：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 一种是没有中间件的</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./redux'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initState<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 一种是有中间件的</span>
<span class="token keyword">const</span> newCreateStore <span class="token operator">=</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>loggerMiddle<span class="token punctuation">,</span> timeMiddleware<span class="token punctuation">)</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">newCreateStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initState<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>为了在使用的时候不考虑这些情况，能用统一的方式去使用最为方便，再进行一下优化，将 applyMiddleware 作为一个参数传入：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">createStore</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> initState<span class="token punctuation">,</span> rewriteCreateStoreFun</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果有 rewriteCreateStoreFun ，就采用新的 createStore</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rewriteCreateStoreFun<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> newCreateStore <span class="token operator">=</span> <span class="token function">rewriteCreateStoreFun</span><span class="token punctuation">(</span>createStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">newCreateStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initState<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 否则，就是用正常的 createStore</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样使用起来就很方便了：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 如果有中间件 </span>
<span class="token keyword">const</span> rewriteCreateStoreFun <span class="token operator">=</span> <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>middleware1<span class="token punctuation">,</span> middleware2<span class="token punctuation">,</span> middleware3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initState<span class="token punctuation">,</span> rewriteCreateStoreFun<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果没有中间件，不传递第三个参数即可</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducer<span class="token punctuation">,</span> initState<span class="token punctuation">)</span>
</code></pre></div></li></ol> <h3 id="_4-省略-initstate"><a href="#_4-省略-initstate" class="header-anchor">#</a> 4. 省略 initState</h3> <p>在 Redux 中，<code>createStore</code> 可以不用传入 <code>initState</code> 参数的，这一步很简单，直接改造 <code>createStore</code> 传入参数即可：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">createStore</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reducer<span class="token punctuation">,</span> initState<span class="token punctuation">,</span> rewriteCreateStoreFun</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 因为 initState 应当是一个对象，rewriteCreateStoreFun 是一个函数，所以直接判断第二个参数的类型即可</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> initState <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果没传入 initState 参数，那么 rewriteCreateStoreFun 就是第二个参数，应当为 function 类型</span>
    rewriteCreateStoreFun <span class="token operator">=</span> initState<span class="token punctuation">;</span>
    initState <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样在不传入 <code>initState</code> 的情况下，也能正常使用了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 创建 store</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>
  reducer<span class="token punctuation">,</span>
  <span class="token function">applyMiddleware</span><span class="token punctuation">(</span>timeMiddleware<span class="token punctuation">,</span> loggerMiddleware<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_4-总结redux"><a href="#_4-总结redux" class="header-anchor">#</a> 4. 总结Redux</h2> <p>对于上面逐步实现的一个 Redux ，已经是日常所遇到常见的 Redux 了，原文中还有对几个高级API的实现，因为日常所用不多，未进行深入研究，后续再进行补全，膜拜原文大佬。Redux 常见的名词做个总结：</p> <ul><li><p><code>createStore</code></p> <p>用来创建 store 对象，包含 <code>getState</code> , <code>dispatch</code> , <code>subscribe</code> , <code>replaceReducer</code></p></li> <li><p><code>reducer</code></p> <p><code>reducer</code> 是一个计划函数(plan)，接收旧的 <code>state</code> 和 <code>action</code>，生成新的 <code>state</code></p></li> <li><p><code>action</code></p> <p><code>action</code> 是一个对象，必须包含<code>type</code> 字段</p></li> <li><p><code>dispatch</code></p> <p><code>dispatch( action )</code> 是用来改变状态的(changeState)，通过触发 <code>action</code>，生成新的 <code>state</code></p></li> <li><p><code>subscribe</code></p> <p>订阅器，用来实现订阅功能，每次触发 <code>dispatch</code> 的时候，会执行订阅函数</p></li> <li><p><code>combineReducers</code></p> <p>合并多个 <code>reducer</code> 成一个<code>reducer</code></p></li> <li><p><code>middleware</code></p> <p>扩展 <code>dispatch</code> 函数，使 <code>dispatch</code> 更强大</p></li> <li><p><code>applyMiddleware</code></p> <p>合并多个<code>middleware</code>，通过重写 <code>dispatch</code> 来简化操作</p></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">12/1/2020, 4:35:44 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/web/React/Redux进阶.html" class="prev">
        Redux进阶
      </a></span> <span class="next"><a href="/web/ReactRouter/拦截器配置.html">
        权限控制
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8fcb3c07.js" defer></script><script src="/assets/js/2.ea4b5fde.js" defer></script><script src="/assets/js/27.8d7291fd.js" defer></script>
  </body>
</html>
