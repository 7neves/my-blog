<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Seven&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="积跬步以至千里，积小流以成江海">
    
    <link rel="preload" href="/assets/css/0.styles.9a488dde.css" as="style"><link rel="preload" href="/assets/js/app.8fcb3c07.js" as="script"><link rel="preload" href="/assets/js/2.ea4b5fde.js" as="script"><link rel="preload" href="/assets/js/25.f5c553f3.js" as="script"><link rel="preload" href="/assets/js/3.482fc7d1.js" as="script"><link rel="prefetch" href="/assets/js/10.ceaff0cb.js"><link rel="prefetch" href="/assets/js/11.602a1a57.js"><link rel="prefetch" href="/assets/js/12.7c9a3565.js"><link rel="prefetch" href="/assets/js/13.cb26c009.js"><link rel="prefetch" href="/assets/js/14.db9f58ed.js"><link rel="prefetch" href="/assets/js/15.c07f99aa.js"><link rel="prefetch" href="/assets/js/16.bbea5198.js"><link rel="prefetch" href="/assets/js/17.bd355204.js"><link rel="prefetch" href="/assets/js/18.069c6795.js"><link rel="prefetch" href="/assets/js/19.2d2f3f2c.js"><link rel="prefetch" href="/assets/js/20.4bf50484.js"><link rel="prefetch" href="/assets/js/21.1bfa4a30.js"><link rel="prefetch" href="/assets/js/22.9b54ca32.js"><link rel="prefetch" href="/assets/js/23.17047d1d.js"><link rel="prefetch" href="/assets/js/24.d36a307c.js"><link rel="prefetch" href="/assets/js/26.cfb8865a.js"><link rel="prefetch" href="/assets/js/27.8d7291fd.js"><link rel="prefetch" href="/assets/js/28.ac3b40d5.js"><link rel="prefetch" href="/assets/js/29.d97a3e56.js"><link rel="prefetch" href="/assets/js/30.f58a4260.js"><link rel="prefetch" href="/assets/js/31.9294edd4.js"><link rel="prefetch" href="/assets/js/32.753d88bb.js"><link rel="prefetch" href="/assets/js/33.4259510b.js"><link rel="prefetch" href="/assets/js/34.767c2061.js"><link rel="prefetch" href="/assets/js/35.ee551374.js"><link rel="prefetch" href="/assets/js/36.67e65bf0.js"><link rel="prefetch" href="/assets/js/37.39a7a34a.js"><link rel="prefetch" href="/assets/js/4.6162bcf8.js"><link rel="prefetch" href="/assets/js/5.43fabd26.js"><link rel="prefetch" href="/assets/js/6.bfd296f5.js"><link rel="prefetch" href="/assets/js/7.da21fdf7.js"><link rel="prefetch" href="/assets/js/8.13301773.js"><link rel="prefetch" href="/assets/js/9.d46e2aae.js">
    <link rel="stylesheet" href="/assets/css/0.styles.9a488dde.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Seven's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/web/" class="nav-link router-link-active">
  web前端
</a></div><div class="nav-item"><a href="/utils/" class="nav-link">
  其他
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/web/" class="nav-link router-link-active">
  web前端
</a></div><div class="nav-item"><a href="/utils/" class="nav-link">
  其他
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>React</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/web/React/React基础.html" class="sidebar-link">React基础</a></li><li><a href="/web/React/如何开发React应用.html" class="sidebar-link">如何开发React应用</a></li><li><a href="/web/React/Redux基础.html" class="active sidebar-link">Redux基础</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/React/Redux基础.html#_1-redux-工作流程" class="sidebar-link">1. Redux 工作流程</a></li><li class="sidebar-sub-header"><a href="/web/React/Redux基础.html#_2-redux-三大原则" class="sidebar-link">2. Redux 三大原则</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/React/Redux基础.html#_1-单一数据源" class="sidebar-link">1. 单一数据源</a></li><li class="sidebar-sub-header"><a href="/web/React/Redux基础.html#_2-state-是只读的" class="sidebar-link">2. state 是只读的</a></li><li class="sidebar-sub-header"><a href="/web/React/Redux基础.html#_3-使用纯函数来执行修改" class="sidebar-link">3. 使用纯函数来执行修改</a></li></ul></li><li class="sidebar-sub-header"><a href="/web/React/Redux基础.html#_3-基本概念" class="sidebar-link">3. 基本概念</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web/React/Redux基础.html#_1-action" class="sidebar-link">1. Action</a></li><li class="sidebar-sub-header"><a href="/web/React/Redux基础.html#_2-reducer" class="sidebar-link">2. Reducer</a></li><li class="sidebar-sub-header"><a href="/web/React/Redux基础.html#_3-store" class="sidebar-link">3. Store</a></li><li class="sidebar-sub-header"><a href="/web/React/Redux基础.html#_4-state" class="sidebar-link">4. State</a></li></ul></li><li class="sidebar-sub-header"><a href="/web/React/Redux基础.html#_4-纯函数" class="sidebar-link">4. 纯函数</a></li></ul></li><li><a href="/web/React/Redux进阶.html" class="sidebar-link">Redux进阶</a></li><li><a href="/web/React/从零开始实现一个Redux.html" class="sidebar-link">从零开始实现一个Redux</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>react-router</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>CSS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>UmiJS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Utils</span> <span class="arrow right"></span></p> <!----></section></li><li><a href="/web/Mobile.html" class="sidebar-link">Mobile</a></li><li><a href="/web/ElementUI.html" class="sidebar-link">ElementUI</a></li><li><a href="/web/FastMock.html" class="sidebar-link">fastmock</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>面试题</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>同Vue应用程序一样，当Vue应用程序复杂起来的时候，需要使用vuex来进行全局状态管理。而React应用也是如此，Redux是React应用程序中进行状态管理的工具之一。使用他们都是非必要的，当应用足够简单的时候一定不要用，反而会提升项目的维护成本。vuex和redux基本都会在以下场景中会用到：</p> <ul><li>需要共享某个组件的状态</li> <li>某个状态需要在任何地方都可以拿到</li> <li>一个组件需要改变全局的状态</li> <li>一个组件需要改变另一个组件的状态</li></ul> <h2 id="_1-redux-工作流程"><a href="#_1-redux-工作流程" class="header-anchor">#</a> 1. Redux 工作流程</h2> <div class="img-wrapper"><img src="https://i.loli.net/2020/03/02/9KhtiAxJF2nrY3Z.png" alt="组件层级划分" class="zoom-img"> <p>组件层级划分</p></div> <p>首先，用户发出 Action。</p> <div class="language-js extra-class"><pre class="language-js"><code>store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后，Store 自动调用 Reducer ，并传入两个参数：当前 State 和收到的 Action。Reducer 返回新的 State。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> nextState <span class="token operator">=</span> <span class="token function">todoApp</span><span class="token punctuation">(</span>previousState<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>State 一旦有变化， Store 就会调用监听函数</p> <div class="language-js extra-class"><pre class="language-js"><code>store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>listener</code> 可以通过 <code>store.getState()</code> 得到当前状态。如果使用的是 React，可以出发重新渲染 view。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> newState <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  component<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_2-redux-三大原则"><a href="#_2-redux-三大原则" class="header-anchor">#</a> 2. Redux 三大原则</h2> <h3 id="_1-单一数据源"><a href="#_1-单一数据源" class="header-anchor">#</a> 1. 单一数据源</h3> <p><strong>整个应用的 state 被存储在一棵 object tree 中，并且这个 object tree 只存在于唯一一个 store 中。</strong><br>
这一原则的优势就是：</p> <ul><li>可以让来自服务端的 state 无需编写更多代码就可以被序列化并注入到视图中。</li> <li>可以让调试更容易。</li> <li>可以把应用的 state 保存在本地，从而加快开发速度。</li></ul> <p>例如：</p> <div class="language-js extra-class"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 假设store设定的如下默认值，就能输出：
{
  inputVal: '',
  list: [
    'TODO 1',
    'TODO 2',
    'TODO 3',
  ]
}
*/</span>
</code></pre></div><h3 id="_2-state-是只读的"><a href="#_2-state-是只读的" class="header-anchor">#</a> 2. state 是只读的</h3> <p><strong>唯一改变 state 的方法就是触发 action ，而 action 是一个用来描述发生了什么的普通对象</strong>。<br>
这样就可以确保视图和网络请求等操作都不能直接修改 state，它们只能用来表达想要修改的意图。因为所有的修改都会被集中化处理，并且严格按照一个接一个的顺序执行，因此不用担心 <a href="https://zh.wikipedia.org/wiki/%E7%AB%B6%E7%88%AD%E5%8D%B1%E5%AE%B3" target="_blank" rel="noopener noreferrer">race condition<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> （也就是并发冲突，导致结果不正确）发生。</p> <h3 id="_3-使用纯函数来执行修改"><a href="#_3-使用纯函数来执行修改" class="header-anchor">#</a> 3. 使用纯函数来执行修改</h3> <p><strong>reducer 是为了描述 action 如何改变 state tree 的唯一方式。</strong><br>
Reducer 只是一些 <a href=""><strong>纯函数</strong></a>，它接收旧的 state 和 action，并返回新的 state。纯函数保证了在它内部不会对传入的 state 和 action 做任何修改，只是单纯的描述 action ，对旧的 state 进行计算之后返回新的。</p> <ul><li>reducer 可以有多个，当随着应用不断变大的时候，可以将 reducer 拆分成多个小的 reducer ，分别独立操作应用的不同模块。而且因为 reducer 只是纯函数，所以它们的调用顺序是可控的。<div class="language-js extra-class"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">reducer1</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'type1'</span><span class="token operator">:</span>
      <span class="token keyword">return</span> newState<span class="token punctuation">;</span>
    <span class="token keyword">default</span> <span class="token operator">:</span>
      <span class="token keyword">return</span> state
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">reducer2</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'type1'</span><span class="token operator">:</span>
      <span class="token keyword">return</span> newState<span class="token punctuation">;</span>
    <span class="token keyword">default</span> <span class="token operator">:</span>
      <span class="token keyword">return</span> state
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">import</span> <span class="token punctuation">{</span>combineReducers<span class="token punctuation">,</span> createStore<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span><span class="token punctuation">;</span>
<span class="token comment">// 将 reducer 进行合并</span>
<span class="token keyword">let</span> reducer <span class="token operator">=</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span>reducer1<span class="token punctuation">,</span> reducer2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>Reducer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <h2 id="_3-基本概念"><a href="#_3-基本概念" class="header-anchor">#</a> 3. 基本概念</h2> <h3 id="_1-action"><a href="#_1-action" class="header-anchor">#</a> 1. <a href="https://www.redux.org.cn/docs/basics/Actions.html" target="_blank" rel="noopener noreferrer"><code>Action</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <ol><li>概念<br> <strong>Action 就是消息通知，主要用来描述消息的内容。</strong><br> <code>State</code> 的变化会导致组件的重新渲染，也就是 <code>View</code> 的变化。但是用户接触不到 <code>State</code>，只能接触到 <code>View</code>。所以，<code>State</code> 的变化必须是由 <code>View</code> 导致的，也就是必须在组件中触发的。<code>Action</code> 就是组件发出的通知，表示 <code>State</code> 应该要发生变化了。<br> <code>Action</code> 是一个对象，<strong>其中 <code>type</code> 属性是必须的</strong>，表示要执行的动作。同时可以设置其他属性，类似vuex中的载荷。如：<div class="language-js extra-class"><div class="highlight-lines"><br><div class="highlighted"> </div><br><br><br><br></div><pre class="language-js"><code><span class="token comment">// 如下 Action 的名称是 `ADD_ITEM`, 携带的载荷信息是 `some info`;</span>
<span class="token keyword">const</span> action <span class="token operator">=</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'ADD_ITEM'</span><span class="token punctuation">,</span>
  payload<span class="token operator">:</span> <span class="token string">'some info'</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><strong>注意</strong>：<code>Action</code> 是唯一能改变 store 中 <code>State</code> 的载荷，它也是 store 数据的唯一来源。</li></ul></li> <li>Action 创建函数（又叫Action Creator）<br>
Action 创建函数就是生成 Action 的方法。“action” 和 “action 创建函数”是不同的概念。“action 创建函数”的意义更倾向于逻辑的封装，当然也可以生成 action。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">changeInput</span><span class="token punctuation">(</span><span class="token parameter">inputVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    type<span class="token operator">:</span> <span class="token constant">CHANGE_INPUT</span><span class="token punctuation">,</span>
    inputVal
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <p>Action 只是一个描述消息内容的对象，它并没有描述应用如何更新 state，也不会自己主动发出。</p></div> <h3 id="_2-reducer"><a href="#_2-reducer" class="header-anchor">#</a> 2. <a href="https://www.redux.org.cn/docs/basics/Reducers.html" target="_blank" rel="noopener noreferrer"><code>Reducer</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <ol><li><p>概念<br> <strong><code>Reducer</code> 指定了应用状态的变化如何响应 <code>action</code> 并发送到 store 的</strong>。<br> <code>Reducer</code> 是把 <code>action</code> 和 <code>state</code> 连接起来的<strong>纯函数</strong>。</p></li> <li><p>Reducer 的来源<br>
之所以叫做 <code>reducer</code> ，是因为它可以作为数组 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/Reduce" target="_blank" rel="noopener noreferrer"><code>reduce(reducer[,initialValue])</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 方法的 <code>reducer</code> 参数。</p> <blockquote><p><code>reduce</code> 属于一种高阶函数，它将其中的回调函数 <code>reducer</code> 递归应用到所有的元素上并返回一个独立的值。达到“缩减”或“折叠”。 ----《<a href="https://zhuanlan.zhihu.com/p/25863768" target="_blank" rel="noopener noreferrer">Reducer为什么叫做Reducer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>》</p></blockquote></li> <li><p><strong>永远保持 <code>reducer</code> 的纯净</strong><br>
无论何时都不应在 <code>reducer</code> 里做这些操作：</p> <ul><li>修改传入的参数；</li> <li>执行有副作用的操作，如 API 请求和路由跳转；</li> <li>调用非纯函数，如 <code>Date.now()</code> 或 <code>Math.random()</code>。</li></ul> <p><strong>在 <code>reducer</code> 中，只要传入的参数相同，返回计算得到的下一个 state 就一定相同。没有特殊情况，没有副作用，没有 API 请求，没有变量修改，只有单纯的执行计算。</strong></p></li> <li><p>编写 reducer<br>
以指定 state 的初始状态开始。在 Redux 首次执行时， state 为 <code>undefined</code>，是没有任何值的，此时可以借机设置并返回应用的初始 state。</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> VisibilityFilters <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./actions'</span>

<span class="token keyword">const</span> initialState <span class="token operator">=</span> <span class="token punctuation">{</span>
  visibilityFilter<span class="token operator">:</span> VisibilityFilters<span class="token punctuation">.</span><span class="token constant">SHOW_ALL</span><span class="token punctuation">,</span>
  todos<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// 使用 ES6 参数默认值语法可以直接设置参数默认值</span>
<span class="token keyword">function</span> <span class="token function">todoApp</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">===</span> initialState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  
  <span class="token comment">// 这里暂不处理任何 action ，仅返回传入的 state</span>
  <span class="token keyword">return</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>处理一个 action: <code>SET_VISIBILITY_FILTER</code>。需要做的是指改变 state 中的 <code>visibilityFilter</code>。</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">todoApp</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">===</span> initialState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">SET_VISIBILITY_FILTER</span><span class="token operator">:</span>
      <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        visibilityFilter<span class="token operator">:</span> action<span class="token punctuation">.</span>filter
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> state
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <ol><li><strong>不要修改 <code>state</code></strong>。使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/assign" target="_blank" rel="noopener noreferrer"><code>Object.assign()</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的方式新建一个副本。而不是像这样 <code>Object.assign(state, {visibilityFilter: false})</code> ，因为它会改变第一个参数的值。将第一个参数设置为对象，这样可以确保 state 不被修改。</li> <li><strong>在 default 情况下返回 state</strong>。这样可以在遇到未知 action 的时候，都确保返回旧的 state。</li></ol></div></li> <li><p>拆分 Reducer<br>
由于整个应用只有一个 state 对象，包含了所有数据，当应用越来越复杂的时候， state 必然会十分庞大，导致 Reducer 也越来越庞大。这时可以开发一个函数作为主 reducer ，它调用多个子 reducer 分别处理 state 中的一部分数据，然后再把这些数据合成一个大的单一对象。</p> <div class="custom-block warning"><p class="custom-block-title">拆分 Reducer 原则</p> <p>应当以 reducer 处理的 state 进行拆分，当不同的 reducer 处理 state 中的字段有依赖时，需要慎重考虑是否应该拆分。</p></div> <p>例如：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">TodoListReducer</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> defaultState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">CHANGE_INPUT</span><span class="token operator">:</span>
      <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        inputVal<span class="token operator">:</span> action<span class="token punctuation">.</span>inputVal
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token constant">ADD_ITEM</span><span class="token operator">:</span>
      <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        list<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token operator">...</span>state<span class="token punctuation">.</span>list<span class="token punctuation">,</span>
          action<span class="token punctuation">.</span>item
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> <span class="token constant">REMOVE_ITEM</span><span class="token operator">:</span>
      <span class="token keyword">let</span> localList <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      localList<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        list<span class="token operator">:</span> localList
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上例中三个 action 分别改变了 state 的两个属性</p> <ul><li>CHANGE_INPUT：<code>inputVal</code> 属性</li> <li>ADD_ITEM：<code>list</code> 属性</li> <li>REMOVE_ITEM：<code>list</code> 属性
这两个属性之间没有联系，便可以将 Reducer 函数进行拆分。不同的子 reducer 处理不同的属性。最终把它们合并到主 Reducer 函数中去。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// inputChange reducer</span>
<span class="token keyword">function</span> <span class="token function">inputChange</span><span class="token punctuation">(</span>state <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">,</span> action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">CHANGE_INPUT</span><span class="token operator">:</span>
      <span class="token keyword">return</span> action<span class="token punctuation">.</span>inputVal<span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// list reducer</span>
<span class="token keyword">function</span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>action<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">ADD_ITEM</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token operator">...</span>state<span class="token punctuation">,</span>
        action<span class="token punctuation">.</span>item
      <span class="token punctuation">]</span>
    <span class="token keyword">case</span> <span class="token constant">REMOVE_ITEM</span><span class="token operator">:</span>
      <span class="token keyword">let</span> localList <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      localList<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span>action<span class="token punctuation">.</span>index<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> localList<span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> state<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 主 reducer 函数</span>
<span class="token keyword">const</span> <span class="token function-variable function">TodoListReducer</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">state <span class="token operator">=</span> defaultState<span class="token punctuation">,</span> action</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    inputChange<span class="token operator">:</span> <span class="token function">inputChange</span><span class="token punctuation">(</span>state <span class="token operator">=</span> defaultState<span class="token punctuation">.</span>inputVal<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">,</span>
    list<span class="token operator">:</span> <span class="token function">list</span><span class="token punctuation">(</span>state <span class="token operator">=</span> defaultState<span class="token punctuation">.</span>list<span class="token punctuation">,</span> action<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>combineReducers</code> 合并函数<br>
Redux 提供了 <code>combineReducers</code> 函数，用于将各个子 reducer 合并成一个主 Reducer 函数。<div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 合并 reducer</span>
<span class="token keyword">const</span> TodoListReducer <span class="token operator">=</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token comment">// 当处理的 state 的属性名与子 reducer 不同名时使用下列写法：</span>
  inputVal<span class="token operator">:</span> inputChange<span class="token punctuation">,</span>
  <span class="token comment">// 当处理的 state 的属性名与子 reducer 同名时，可以使用下列简写：</span>
  list
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div>最后可以将所有子 reducer 放在一个文件里面，然后统一引入：<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> combineReducers <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'redux'</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> reducers <span class="token keyword">from</span> <span class="token string">'./reducers'</span>

<span class="token keyword">const</span> reducer <span class="token operator">=</span> <span class="token function">combineReducers</span><span class="token punctuation">(</span>reducers<span class="token punctuation">)</span>
</code></pre></div></li></ul></li></ol> <h3 id="_3-store"><a href="#_3-store" class="header-anchor">#</a> 3. <a href="https://www.redux.org.cn/docs/basics/Store.html" target="_blank" rel="noopener noreferrer"><code>Store</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h3> <p>前面知道了 <code>action</code> 是用来描述“发生了什么”，以及使用 <code>reducer()</code> 来根据 <code>action</code> 更新 state 的用法。<br> <strong>Store</strong> 就是将它们联系在一起的对象。 Store 有以下职责：</p> <ul><li>维持应用的 state;</li> <li>提供 <code>getState()</code> 方法获取 state;</li> <li>提供 <code>dispatch(action)</code> 方法更新 state，<strong>派发 action 的唯一途径</strong>;</li> <li>通过 <code>subscribe(listener)</code> 方法注册监听器；<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>storeChange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">storeChange</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>storeChange<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">...</span>
<span class="token function">storeChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li>通过 <code>subscribe(listener)</code> 返回的函数注销监听器。<div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> unsubscribe <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token function">unsubscribe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul> <p>再次强调 <strong>Redux 应用只有一个单一的 store</strong>。当需要拆分数据处理逻辑时，应当使用 reducer 组合，而不是创建多个 store。</p> <p>Redux提供 <code>createStore()</code> 函数，来创建 Store。</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span>
<span class="token comment">// 接收一个函数作为参数，返回新生成的store对象</span>
<span class="token keyword">import</span> reducerFn <span class="token keyword">from</span> <span class="token string">'./reducer.js'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token function">createStore</span><span class="token punctuation">(</span>reducerFn<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> store<span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-state"><a href="#_4-state" class="header-anchor">#</a> 4. <code>State</code></h3> <p>某个时点(组件)的数据集合<br> <code>Store</code> 对象包含了整个应用的数据。在组件中获得的数据集合，就是 <code>State</code>。要获取当前组件的 <code>State</code> ，需要通过 <code>store.getState()</code> 函数。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// Component.js</span>
<span class="token keyword">import</span> store <span class="token keyword">from</span> <span class="token string">'store'</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> store<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_4-纯函数"><a href="#_4-纯函数" class="header-anchor">#</a> 4. <a href="https://zh.wikipedia.org/zh-hans/%E7%BA%AF%E5%87%BD%E6%95%B0" target="_blank" rel="noopener noreferrer">纯函数<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></h2> <ol><li><p>Reducer 最终要的特征就是，它是一个纯函数。所谓纯函数，就是在传如参数一样的情况下，总会得到相同的结果。</p> <blockquote><p>如果函数的调用参数相同，则永远返回相同的结果。它不依赖于程序执行期间函数外部任何状态或数据的变化，必须只依赖于其输入参数。</p></blockquote> <p>它必须遵守以下约束:</p> <ul><li>不能改写参数</li> <li>不能调用系统 I/O 的API</li> <li>不能调用如 <code>Date.now()</code> 或者 <code>Math.random()</code> 等不纯的方法，因为每次调用都会返回不同的结果</li></ul></li> <li><p>为什么Reducer必须是纯函数？<br>
因为这样就可以保证在同样的 State 情况下，必定得到同样的 View。同时这也就限定了在Reducer中不能改变 State，必须返回一个全新的对象。</p></li></ol></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">12/1/2020, 4:35:44 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/web/React/如何开发React应用.html" class="prev">
        如何开发React应用
      </a></span> <span class="next"><a href="/web/React/Redux进阶.html">
        Redux进阶
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.8fcb3c07.js" defer></script><script src="/assets/js/2.ea4b5fde.js" defer></script><script src="/assets/js/25.f5c553f3.js" defer></script><script src="/assets/js/3.482fc7d1.js" defer></script>
  </body>
</html>
